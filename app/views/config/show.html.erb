<% content_for :title, "設定 | #{blog_title}" %>
<% content_for :description, "General Letter Publication System based on ActivityPub" %>

<!-- ブログ風設定ページ -->
<div class="max-w-2xl mx-auto">
  <!-- 設定ページヘッダー -->
  <header class="mb-12 text-center">
    <h1 class="text-xl sm:text-2xl text-gray-900" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 300;">
      設定
    </h1>
  </header>

  <!-- 設定フォーム -->
  <%= form_with url: config_path, method: :patch, local: true, class: "space-y-8", onsubmit: "return true" do |form| %>
    
    <!-- インスタンス情報セクション -->
    <section class="border border-gray-300 p-6">
      <h2 class="text-lg text-gray-900 mb-4" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 400;">
        インスタンス情報
      </h2>
      
      <div class="space-y-4">
        <div>
          <%= form.label "config[instance_name]", "インスタンス名", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <%= form.text_field "config[instance_name]", 
              value: @config[:instance_name],
              placeholder: "インスタンス名（ブログタイトル）",
              class: "w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
        </div>

        <div>
          <%= form.label "config[instance_description]", "説明", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <%= form.text_area "config[instance_description]", 
              value: @config[:instance_description],
              placeholder: "インスタンスの説明",
              rows: 3,
              class: "w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors resize-none",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
        </div>

        <div>
          <%= form.label "config[instance_contact_email]", "連絡先メール", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <%= form.email_field "config[instance_contact_email]", 
              value: @config[:instance_contact_email],
              placeholder: "contact@example.com",
              class: "w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
        </div>

        <div>
          <%= form.label "config[instance_maintainer]", "管理者名", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <%= form.text_field "config[instance_maintainer]", 
              value: @config[:instance_maintainer],
              placeholder: "管理者名",
              class: "w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
        </div>

        <div>
          <%= form.label "config[blog_footer]", "フッター", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <%= form.text_field "config[blog_footer]", 
              value: @config[:blog_footer],
              placeholder: "フッターに表示するテキスト",
              class: "w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
        </div>

      </div>
    </section>

    <!-- ユーザプロフィールセクション -->
    <section class="border border-gray-300 p-6">
      <h2 class="text-lg text-gray-900 mb-4" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 400;">
        プロフィール設定
      </h2>
      
      <div class="space-y-4">
        <div>
          <%= form.label "actor[avatar]", "プロフィール画像", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          
          <div class="border border-gray-300 border-dashed p-6 text-center hover:border-gray-400 transition-colors">
            <%= form.file_field "actor[avatar]", 
                accept: "image/*",
                class: "hidden",
                id: "icon_upload",
                onchange: "previewProfileImage(this)" %>
            <label for="icon_upload" class="cursor-pointer">
              <div id="profile_image_preview_container" class="<%= 'hidden' unless current_user&.avatar&.attached? %>">
                <% if current_user&.avatar&.attached? %>
                  <img id="profile_image_preview" src="<%= url_for(current_user.avatar) %>" class="mx-auto max-w-16 max-h-16 object-contain mb-2 rounded">
                <% else %>
                  <img id="profile_image_preview" class="mx-auto max-w-16 max-h-16 object-contain mb-2 rounded">
                <% end %>
                <p class="text-sm text-gray-600" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 400;">
                  クリックして変更
                </p>
              </div>
              <div id="profile_upload_placeholder" class="<%= 'hidden' if current_user&.avatar&.attached? %>">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                  <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="mt-2 text-sm text-gray-600" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 400;">
                  <span class="font-medium">クリックしてファイルを選択</span> またはドラッグ&ドロップ
                </p>
                <p class="text-xs text-gray-500" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 300;">
                  PNG, JPG, GIF, WebP対応（推奨サイズ: 400x400px）
                </p>
              </div>
            </label>
          </div>
        </div>

        <div>
          <%= form.label "actor[summary]", "自己紹介", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <%= form.text_area "actor[summary]", 
              value: current_user&.summary,
              placeholder: "あなたの自己紹介を入力してください",
              rows: 4,
              class: "w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors resize-none",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <p class="text-xs text-gray-500 mt-1" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 300;">
            https://から始まるURLは自動的にリンクになります
          </p>
        </div>
      </div>
    </section>

    <!-- インスタンス管理セクション -->
    <section class="border border-gray-300 p-6">
      <h2 class="text-lg text-gray-900 mb-4" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 400;">
        インスタンス管理
      </h2>
      
      <div class="space-y-4">
        <div>
          <%= link_to "カスタム絵文字の管理", config_custom_emojis_path, 
              class: "px-3 py-1 border border-gray-300 text-gray-900 hover:bg-gray-50 transition-colors cursor-pointer text-sm",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <p class="text-sm text-gray-500 mt-1" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 300;">
            インスタンス独自の絵文字を追加・管理できます
          </p>
        </div>
        
      </div>
    </section>

    <!-- Cloudflare R2 設定セクション -->
    <section class="border border-gray-300 p-6">
      <h2 class="text-lg text-gray-900 mb-4" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 400;">
        オブジェクトストレージ設定
      </h2>
      
      <div class="space-y-4">
        <div>
          <label class="flex items-center">
            <%= form.check_box "config[s3_enabled]", 
                { checked: @config[:s3_enabled], class: "mr-2", 
                  style: "appearance: none; width: 1rem; height: 1rem; border: 1px solid #d1d5db; background-color: white; position: relative; cursor: pointer;" }, 
                "1", "0" %>
            <span class="text-sm text-gray-700" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 400;">
              オブジェクトストレージを有効にする
            </span>
          </label>
          <style>
            input[name="config[s3_enabled]"]:checked {
              border-color: #6b7280 !important;
              background-color: white !important;
            }
            input[name="config[s3_enabled]"]:checked::after {
              content: '';
              position: absolute;
              left: 3px;
              top: 1px;
              width: 6px;
              height: 10px;
              border: solid #6b7280;
              border-width: 0 2px 2px 0;
              transform: rotate(45deg);
            }
            input[name="config[s3_enabled]"]:hover {
              border-color: #9ca3af !important;
            }
          </style>
          <p class="text-xs text-gray-500 mt-1" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 300;">
            有効後、画像がオブジェクトストレージに保存されます。
          </p>
        </div>
        
        <div>
          <%= form.label "config[s3_endpoint]", "R2 エンドポイント", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <%= form.text_field "config[s3_endpoint]", 
              value: @config[:s3_endpoint],
              placeholder: "https://account-id.r2.cloudflarestorage.com",
              class: "w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
        </div>
        
        <div>
          <%= form.label "config[s3_bucket]", "バケット名", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <%= form.text_field "config[s3_bucket]", 
              value: @config[:s3_bucket],
              placeholder: "my-bucket",
              class: "w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
        </div>
        
        <div>
          <%= form.label "config[r2_access_key_id]", "アクセスキーID", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <%= form.text_field "config[r2_access_key_id]", 
              value: @config[:r2_access_key_id],
              placeholder: "アクセスキーID",
              class: "w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
        </div>
        
        <div>
          <%= form.label "config[r2_secret_access_key]", "シークレットアクセスキー", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <%= form.password_field "config[r2_secret_access_key]", 
              value: @config[:r2_secret_access_key],
              placeholder: "シークレットアクセスキー",
              class: "w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
        </div>
        
        <div>
          <%= form.label "config[s3_alias_host]", "カスタムドメイン (オプション)", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <%= form.text_field "config[s3_alias_host]", 
              value: @config[:s3_alias_host],
              placeholder: "files.example.com",
              class: "w-full px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors",
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <p class="text-xs text-gray-500 mt-1" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 300;">
            カスタムドメインでファイルを配信する場合のドメイン名
          </p>
        </div>
      </div>
    </section>

    <!-- デザインセクション -->
    <section class="border border-gray-300 p-6">
      <h2 class="text-lg text-gray-900 mb-4" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 400;">
        デザイン設定
      </h2>
      
      <div class="space-y-4">
        <div>
          <%= form.label "config[background_color]", "背景色", 
              class: "block text-sm text-gray-700 mb-2", 
              style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
          <div class="flex items-center space-x-3">
            <%= form.text_field "config[background_color]", 
                value: @config[:background_color],
                placeholder: "#fdfbfb",
                pattern: "#[0-9a-fA-F]{6}",
                class: "flex-1 px-3 py-2 border border-gray-300 focus:outline-none focus:border-gray-500 transition-colors font-mono",
                style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;",
                id: "background_color_input",
                oninput: "updateColorPreview(this.value)" %>
            <div class="w-10 h-10 rounded border border-gray-300" 
                 style="background-color: <%= @config[:background_color] %>;" 
                 title="現在の背景色"
                 id="color_preview"></div>
          </div>
          <p class="text-xs text-gray-500 mt-1" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 300;">
            #から始まる6桁のカラーコードで入力してください（例: #fdfbfb）
          </p>
        </div>
      </div>
    </section>

    <!-- 保存ボタン -->
    <div class="pt-4 text-right">
      <%= form.submit "保存", 
          class: "px-3 py-1 border border-gray-300 text-gray-900 hover:bg-gray-50 transition-colors cursor-pointer text-sm",
          style: "font-family: 'Noto Sans JP', sans-serif; font-weight: 400;" %>
    </div>
  <% end %>

  <!-- 成功メッセージ -->
  <% if flash[:notice] %>
    <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-md">
      <p class="text-sm text-green-700" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 400;">
        <%= flash[:notice] %>
      </p>
    </div>
  <% end %>

  <!-- エラーメッセージ -->
  <% if flash[:alert] %>
    <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-md">
      <p class="text-sm text-red-700" style="font-family: 'Noto Sans JP', sans-serif; font-weight: 400;">
        <%= flash[:alert] %>
      </p>
    </div>
  <% end %>
</div>

<script>
function updateColorPreview(color) {
  const preview = document.getElementById('color_preview');
  if (color.match(/^#[0-9a-fA-F]{6}$/)) {
    preview.style.backgroundColor = color;
    preview.style.borderColor = '#d1d5db'; // gray-300
  } else {
    preview.style.backgroundColor = '#f3f4f6'; // gray-100
    preview.style.borderColor = '#ef4444'; // red-500
  }
}

function previewImageGeneric(input, previewId, previewContainerId, placeholderId) {
  const file = input.files[0];
  const preview = document.getElementById(previewId);
  const previewContainer = document.getElementById(previewContainerId);
  const placeholder = document.getElementById(placeholderId);
  
  if (file) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      preview.src = e.target.result;
      previewContainer.classList.remove('hidden');
      placeholder.classList.add('hidden');
    };
    
    reader.readAsDataURL(file);
  }
}

// プロフィール画像専用のラッパー関数
function previewProfileImage(input) {
  previewImageGeneric(input, 'profile_image_preview', 'profile_image_preview_container', 'profile_upload_placeholder');
}

// ドラッグ&ドロップ対応（汎用化）
function setupDragAndDrop(dropZoneSelector, fileInputId, previewFunction) {
  const dropZone = document.querySelector(dropZoneSelector);
  const fileInput = document.getElementById(fileInputId);
  
  if (dropZone && fileInput) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight(e) {
      dropZone.classList.add('border-gray-500', 'bg-gray-50');
    }
    
    function unhighlight(e) {
      dropZone.classList.remove('border-gray-500', 'bg-gray-50');
    }
    
    dropZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        fileInput.files = files;
        previewFunction(fileInput);
      }
    }
  }
}

// プロフィール画像のドラッグ&ドロップ設定
document.addEventListener('DOMContentLoaded', function() {
  setupDragAndDrop('.border-dashed', 'icon_upload', previewProfileImage);
});
</script>
